name: Sandbox

on:
  workflow_dispatch:
  pull_request:
    types:
      - opened
      - synchronize
    paths-ignore:
      - "**.md"

permissions:
  contents: read
  id-token: write

concurrency:
  group: sandbox
  cancel-in-progress: false

jobs:
  main-sandbox:
    name: Main Sandbox
    runs-on: ubuntu-latest
    if: github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success'
    environment: sandbox

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/228872504660/locations/global/workloadIdentityPools/pt-pneuma-github-sandbox/providers/pt-pneuma-github-sandbox
          service_account: pt-pneuma-github@pt-corpus-tf16-sand.iam.gserviceaccount.com

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.10.4

      - name: Tofu Init
        run: tofu init

      - name: Tofu Workspace Select
        run: tofu workspace select main-sandbox || tofu workspace new main-sandbox

      - name: Tofu Apply
        run: tofu apply -auto-approve

  regional-us-east1-a-sandbox:
    name: Regional us-east1-a-sandbox
    runs-on: ubuntu-latest
    needs: main-sandbox
    environment: sandbox

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/228872504660/locations/global/workloadIdentityPools/pt-pneuma-github-sandbox/providers/pt-pneuma-github-sandbox
          service_account: pt-pneuma-github@pt-corpus-tf16-sand.iam.gserviceaccount.com

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.10.4

      - name: Tofu Init
        run: tofu init
        working-directory: regional

      - name: Tofu Workspace Select
        run: tofu workspace select us-east1-a-sandbox || tofu workspace new us-east1-a-sandbox
        working-directory: regional

      - name: Tofu Apply
        run: tofu apply -auto-approve -var-file=environments/us-east1-a-sandbox.tfvars -var="zone=us-east1-a"
        working-directory: regional

  regional-us-east1-b-sandbox:
    name: Regional us-east1-b-sandbox
    runs-on: ubuntu-latest
    needs: main-sandbox
    environment: sandbox

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/228872504660/locations/global/workloadIdentityPools/pt-pneuma-github-sandbox/providers/pt-pneuma-github-sandbox
          service_account: pt-pneuma-github@pt-corpus-tf16-sand.iam.gserviceaccount.com

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.10.4

      - name: Tofu Init
        run: tofu init
        working-directory: regional

      - name: Tofu Workspace Select
        run: tofu workspace select us-east1-b-sandbox || tofu workspace new us-east1-b-sandbox
        working-directory: regional

      - name: Tofu Apply
        run: tofu apply -auto-approve -var-file=environments/us-east1-b-sandbox.tfvars -var="zone=us-east1-b"
        working-directory: regional

  regional-us-east1-c-sandbox:
    name: Regional us-east1-c-sandbox
    runs-on: ubuntu-latest
    needs: main-sandbox
    environment: sandbox

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/228872504660/locations/global/workloadIdentityPools/pt-pneuma-github-sandbox/providers/pt-pneuma-github-sandbox
          service_account: pt-pneuma-github@pt-corpus-tf16-sand.iam.gserviceaccount.com

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.10.4

      - name: Tofu Init
        run: tofu init
        working-directory: regional

      - name: Tofu Workspace Select
        run: tofu workspace select us-east1-c-sandbox || tofu workspace new us-east1-c-sandbox
        working-directory: regional

      - name: Tofu Apply
        run: tofu apply -auto-approve -var-file=environments/us-east1-c-sandbox.tfvars -var="zone=us-east1-c"
        working-directory: regional

  regional-us-east4-a-sandbox:
    name: Regional us-east4-a-sandbox
    runs-on: ubuntu-latest
    needs: main-sandbox
    environment: sandbox

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/228872504660/locations/global/workloadIdentityPools/pt-pneuma-github-sandbox/providers/pt-pneuma-github-sandbox
          service_account: pt-pneuma-github@pt-corpus-tf16-sand.iam.gserviceaccount.com

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.10.4

      - name: Tofu Init
        run: tofu init
        working-directory: regional

      - name: Tofu Workspace Select
        run: tofu workspace select us-east4-a-sandbox || tofu workspace new us-east4-a-sandbox
        working-directory: regional

      - name: Tofu Apply
        run: tofu apply -auto-approve -var-file=environments/us-east4-a-sandbox.tfvars -var="zone=us-east4-a"
        working-directory: regional

  regional-us-east4-b-sandbox:
    name: Regional us-east4-b-sandbox
    runs-on: ubuntu-latest
    needs: main-sandbox
    environment: sandbox

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/228872504660/locations/global/workloadIdentityPools/pt-pneuma-github-sandbox/providers/pt-pneuma-github-sandbox
          service_account: pt-pneuma-github@pt-corpus-tf16-sand.iam.gserviceaccount.com

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.10.4

      - name: Tofu Init
        run: tofu init
        working-directory: regional

      - name: Tofu Workspace Select
        run: tofu workspace select us-east4-b-sandbox || tofu workspace new us-east4-b-sandbox
        working-directory: regional

      - name: Tofu Apply
        run: tofu apply -auto-approve -var-file=environments/us-east4-b-sandbox.tfvars -var="zone=us-east4-b"
        working-directory: regional

  regional-us-east4-c-sandbox:
    name: Regional us-east4-c-sandbox
    runs-on: ubuntu-latest
    needs: main-sandbox
    environment: sandbox

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/228872504660/locations/global/workloadIdentityPools/pt-pneuma-github-sandbox/providers/pt-pneuma-github-sandbox
          service_account: pt-pneuma-github@pt-corpus-tf16-sand.iam.gserviceaccount.com

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.10.4

      - name: Tofu Init
        run: tofu init
        working-directory: regional

      - name: Tofu Workspace Select
        run: tofu workspace select us-east4-c-sandbox || tofu workspace new us-east4-c-sandbox
        working-directory: regional

      - name: Tofu Apply
        run: tofu apply -auto-approve -var-file=environments/us-east4-c-sandbox.tfvars -var="zone=us-east4-c"
        working-directory: regional

  onboarding-us-east1-a-sandbox:
    name: Onboarding us-east1-a-sandbox
    runs-on: ubuntu-latest
    needs: regional-us-east1-a-sandbox
    environment: sandbox

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/228872504660/locations/global/workloadIdentityPools/pt-pneuma-github-sandbox/providers/pt-pneuma-github-sandbox
          service_account: pt-pneuma-github@pt-corpus-tf16-sand.iam.gserviceaccount.com

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.10.4

      - name: Tofu Init
        run: tofu init
        working-directory: regional/onboarding

      - name: Tofu Workspace Select
        run: tofu workspace select us-east1-a-sandbox || tofu workspace new us-east1-a-sandbox
        working-directory: regional/onboarding

      - name: Tofu Apply
        run: tofu apply -auto-approve -var-file=../environments/us-east1-a-sandbox.tfvars
        working-directory: regional/onboarding

  onboarding-us-east1-b-sandbox:
    name: Onboarding us-east1-b-sandbox
    runs-on: ubuntu-latest
    needs: regional-us-east1-b-sandbox
    environment: sandbox

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/228872504660/locations/global/workloadIdentityPools/pt-pneuma-github-sandbox/providers/pt-pneuma-github-sandbox
          service_account: pt-pneuma-github@pt-corpus-tf16-sand.iam.gserviceaccount.com

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.10.4

      - name: Tofu Init
        run: tofu init
        working-directory: regional/onboarding

      - name: Tofu Workspace Select
        run: tofu workspace select us-east1-b-sandbox || tofu workspace new us-east1-b-sandbox
        working-directory: regional/onboarding

      - name: Tofu Apply
        run: tofu apply -auto-approve -var-file=../environments/us-east1-b-sandbox.tfvars
        working-directory: regional/onboarding

  onboarding-us-east1-c-sandbox:
    name: Onboarding us-east1-c-sandbox
    runs-on: ubuntu-latest
    needs: regional-us-east1-c-sandbox
    environment: sandbox

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/228872504660/locations/global/workloadIdentityPools/pt-pneuma-github-sandbox/providers/pt-pneuma-github-sandbox
          service_account: pt-pneuma-github@pt-corpus-tf16-sand.iam.gserviceaccount.com

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.10.4

      - name: Tofu Init
        run: tofu init
        working-directory: regional/onboarding

      - name: Tofu Workspace Select
        run: tofu workspace select us-east1-c-sandbox || tofu workspace new us-east1-c-sandbox
        working-directory: regional/onboarding

      - name: Tofu Apply
        run: tofu apply -auto-approve -var-file=../environments/us-east1-c-sandbox.tfvars
        working-directory: regional/onboarding

  onboarding-us-east4-a-sandbox:
    name: Onboarding us-east4-a-sandbox
    runs-on: ubuntu-latest
    needs: regional-us-east4-a-sandbox
    environment: sandbox

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/228872504660/locations/global/workloadIdentityPools/pt-pneuma-github-sandbox/providers/pt-pneuma-github-sandbox
          service_account: pt-pneuma-github@pt-corpus-tf16-sand.iam.gserviceaccount.com

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.10.4

      - name: Tofu Init
        run: tofu init
        working-directory: regional/onboarding

      - name: Tofu Workspace Select
        run: tofu workspace select us-east4-a-sandbox || tofu workspace new us-east4-a-sandbox
        working-directory: regional/onboarding

      - name: Tofu Apply
        run: tofu apply -auto-approve -var-file=../environments/us-east4-a-sandbox.tfvars
        working-directory: regional/onboarding

  onboarding-us-east4-b-sandbox:
    name: Onboarding us-east4-b-sandbox
    runs-on: ubuntu-latest
    needs: regional-us-east4-b-sandbox
    environment: sandbox

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/228872504660/locations/global/workloadIdentityPools/pt-pneuma-github-sandbox/providers/pt-pneuma-github-sandbox
          service_account: pt-pneuma-github@pt-corpus-tf16-sand.iam.gserviceaccount.com

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.10.4

      - name: Tofu Init
        run: tofu init
        working-directory: regional/onboarding

      - name: Tofu Workspace Select
        run: tofu workspace select us-east4-b-sandbox || tofu workspace new us-east4-b-sandbox
        working-directory: regional/onboarding

      - name: Tofu Apply
        run: tofu apply -auto-approve -var-file=../environments/us-east4-b-sandbox.tfvars
        working-directory: regional/onboarding

  onboarding-us-east4-c-sandbox:
    name: Onboarding us-east4-c-sandbox
    runs-on: ubuntu-latest
    needs: regional-us-east4-c-sandbox
    environment: sandbox

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/228872504660/locations/global/workloadIdentityPools/pt-pneuma-github-sandbox/providers/pt-pneuma-github-sandbox
          service_account: pt-pneuma-github@pt-corpus-tf16-sand.iam.gserviceaccount.com

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.10.4

      - name: Tofu Init
        run: tofu init
        working-directory: regional/onboarding

      - name: Tofu Workspace Select
        run: tofu workspace select us-east4-c-sandbox || tofu workspace new us-east4-c-sandbox
        working-directory: regional/onboarding

      - name: Tofu Apply
        run: tofu apply -auto-approve -var-file=../environments/us-east4-c-sandbox.tfvars
        working-directory: regional/onboarding

  cert-manager-us-east1-a-sandbox:
    name: Cert Manager us-east1-a-sandbox
    runs-on: ubuntu-latest
    needs: onboarding-us-east1-a-sandbox
    environment: sandbox

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/228872504660/locations/global/workloadIdentityPools/pt-pneuma-github-sandbox/providers/pt-pneuma-github-sandbox
          service_account: pt-pneuma-github@pt-corpus-tf16-sand.iam.gserviceaccount.com

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.10.4

      - name: Tofu Init
        run: tofu init
        working-directory: regional/cert-manager

      - name: Tofu Workspace Select
        run: tofu workspace select us-east1-a-sandbox || tofu workspace new us-east1-a-sandbox
        working-directory: regional/cert-manager

      - name: Tofu Apply
        run: tofu apply -auto-approve -var-file=../environments/us-east1-a-sandbox.tfvars
        working-directory: regional/cert-manager

  cert-manager-us-east1-b-sandbox:
    name: Cert Manager us-east1-b-sandbox
    runs-on: ubuntu-latest
    needs: onboarding-us-east1-b-sandbox
    environment: sandbox

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/228872504660/locations/global/workloadIdentityPools/pt-pneuma-github-sandbox/providers/pt-pneuma-github-sandbox
          service_account: pt-pneuma-github@pt-corpus-tf16-sand.iam.gserviceaccount.com

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.10.4

      - name: Tofu Init
        run: tofu init
        working-directory: regional/cert-manager

      - name: Tofu Workspace Select
        run: tofu workspace select us-east1-b-sandbox || tofu workspace new us-east1-b-sandbox
        working-directory: regional/cert-manager

      - name: Tofu Apply
        run: tofu apply -auto-approve -var-file=../environments/us-east1-b-sandbox.tfvars
        working-directory: regional/cert-manager

  cert-manager-us-east1-c-sandbox:
    name: Cert Manager us-east1-c-sandbox
    runs-on: ubuntu-latest
    needs: onboarding-us-east1-c-sandbox
    environment: sandbox

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/228872504660/locations/global/workloadIdentityPools/pt-pneuma-github-sandbox/providers/pt-pneuma-github-sandbox
          service_account: pt-pneuma-github@pt-corpus-tf16-sand.iam.gserviceaccount.com

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.10.4

      - name: Tofu Init
        run: tofu init
        working-directory: regional/cert-manager

      - name: Tofu Workspace Select
        run: tofu workspace select us-east1-c-sandbox || tofu workspace new us-east1-c-sandbox
        working-directory: regional/cert-manager

      - name: Tofu Apply
        run: tofu apply -auto-approve -var-file=../environments/us-east1-c-sandbox.tfvars
        working-directory: regional/cert-manager

  cert-manager-us-east4-a-sandbox:
    name: Cert Manager us-east4-a-sandbox
    runs-on: ubuntu-latest
    needs: onboarding-us-east4-a-sandbox
    environment: sandbox

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/228872504660/locations/global/workloadIdentityPools/pt-pneuma-github-sandbox/providers/pt-pneuma-github-sandbox
          service_account: pt-pneuma-github@pt-corpus-tf16-sand.iam.gserviceaccount.com

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.10.4

      - name: Tofu Init
        run: tofu init
        working-directory: regional/cert-manager

      - name: Tofu Workspace Select
        run: tofu workspace select us-east4-a-sandbox || tofu workspace new us-east4-a-sandbox
        working-directory: regional/cert-manager

      - name: Tofu Apply
        run: tofu apply -auto-approve -var-file=../environments/us-east4-a-sandbox.tfvars
        working-directory: regional/cert-manager

  cert-manager-us-east4-b-sandbox:
    name: Cert Manager us-east4-b-sandbox
    runs-on: ubuntu-latest
    needs: onboarding-us-east4-b-sandbox
    environment: sandbox

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/228872504660/locations/global/workloadIdentityPools/pt-pneuma-github-sandbox/providers/pt-pneuma-github-sandbox
          service_account: pt-pneuma-github@pt-corpus-tf16-sand.iam.gserviceaccount.com

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.10.4

      - name: Tofu Init
        run: tofu init
        working-directory: regional/cert-manager

      - name: Tofu Workspace Select
        run: tofu workspace select us-east4-b-sandbox || tofu workspace new us-east4-b-sandbox
        working-directory: regional/cert-manager

      - name: Tofu Apply
        run: tofu apply -auto-approve -var-file=../environments/us-east4-b-sandbox.tfvars
        working-directory: regional/cert-manager

  cert-manager-us-east4-c-sandbox:
    name: Cert Manager us-east4-c-sandbox
    runs-on: ubuntu-latest
    needs: onboarding-us-east4-c-sandbox
    environment: sandbox

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/228872504660/locations/global/workloadIdentityPools/pt-pneuma-github-sandbox/providers/pt-pneuma-github-sandbox
          service_account: pt-pneuma-github@pt-corpus-tf16-sand.iam.gserviceaccount.com

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.10.4

      - name: Tofu Init
        run: tofu init
        working-directory: regional/cert-manager

      - name: Tofu Workspace Select
        run: tofu workspace select us-east4-c-sandbox || tofu workspace new us-east4-c-sandbox
        working-directory: regional/cert-manager

      - name: Tofu Apply
        run: tofu apply -auto-approve -var-file=../environments/us-east4-c-sandbox.tfvars
        working-directory: regional/cert-manager

  opa-gatekeeper-us-east1-a-sandbox:
    name: OPA Gatekeeper us-east1-a-sandbox
    runs-on: ubuntu-latest
    needs: cert-manager-us-east1-a-sandbox
    environment: sandbox

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/228872504660/locations/global/workloadIdentityPools/pt-pneuma-github-sandbox/providers/pt-pneuma-github-sandbox
          service_account: pt-pneuma-github@pt-corpus-tf16-sand.iam.gserviceaccount.com

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.10.4

      - name: Tofu Init
        run: tofu init
        working-directory: regional/opa-gatekeeper

      - name: Tofu Workspace Select
        run: tofu workspace select us-east1-a-sandbox || tofu workspace new us-east1-a-sandbox
        working-directory: regional/opa-gatekeeper

      - name: Tofu Apply
        run: tofu apply -auto-approve -var-file=../environments/us-east1-a-sandbox.tfvars
        working-directory: regional/opa-gatekeeper

  opa-gatekeeper-us-east1-b-sandbox:
    name: OPA Gatekeeper us-east1-b-sandbox
    runs-on: ubuntu-latest
    needs: cert-manager-us-east1-b-sandbox
    environment: sandbox

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/228872504660/locations/global/workloadIdentityPools/pt-pneuma-github-sandbox/providers/pt-pneuma-github-sandbox
          service_account: pt-pneuma-github@pt-corpus-tf16-sand.iam.gserviceaccount.com

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.10.4

      - name: Tofu Init
        run: tofu init
        working-directory: regional/opa-gatekeeper

      - name: Tofu Workspace Select
        run: tofu workspace select us-east1-b-sandbox || tofu workspace new us-east1-b-sandbox
        working-directory: regional/opa-gatekeeper

      - name: Tofu Apply
        run: tofu apply -auto-approve -var-file=../environments/us-east1-b-sandbox.tfvars
        working-directory: regional/opa-gatekeeper

  opa-gatekeeper-us-east1-c-sandbox:
    name: OPA Gatekeeper us-east1-c-sandbox
    runs-on: ubuntu-latest
    needs: cert-manager-us-east1-c-sandbox
    environment: sandbox

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/228872504660/locations/global/workloadIdentityPools/pt-pneuma-github-sandbox/providers/pt-pneuma-github-sandbox
          service_account: pt-pneuma-github@pt-corpus-tf16-sand.iam.gserviceaccount.com

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.10.4

      - name: Tofu Init
        run: tofu init
        working-directory: regional/opa-gatekeeper

      - name: Tofu Workspace Select
        run: tofu workspace select us-east1-c-sandbox || tofu workspace new us-east1-c-sandbox
        working-directory: regional/opa-gatekeeper

      - name: Tofu Apply
        run: tofu apply -auto-approve -var-file=../environments/us-east1-c-sandbox.tfvars
        working-directory: regional/opa-gatekeeper

  opa-gatekeeper-us-east4-a-sandbox:
    name: OPA Gatekeeper us-east4-a-sandbox
    runs-on: ubuntu-latest
    needs: cert-manager-us-east4-a-sandbox
    environment: sandbox

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/228872504660/locations/global/workloadIdentityPools/pt-pneuma-github-sandbox/providers/pt-pneuma-github-sandbox
          service_account: pt-pneuma-github@pt-corpus-tf16-sand.iam.gserviceaccount.com

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.10.4

      - name: Tofu Init
        run: tofu init
        working-directory: regional/opa-gatekeeper

      - name: Tofu Workspace Select
        run: tofu workspace select us-east4-a-sandbox || tofu workspace new us-east4-a-sandbox
        working-directory: regional/opa-gatekeeper

      - name: Tofu Apply
        run: tofu apply -auto-approve -var-file=../environments/us-east4-a-sandbox.tfvars
        working-directory: regional/opa-gatekeeper

  opa-gatekeeper-us-east4-b-sandbox:
    name: OPA Gatekeeper us-east4-b-sandbox
    runs-on: ubuntu-latest
    needs: cert-manager-us-east4-b-sandbox
    environment: sandbox

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/228872504660/locations/global/workloadIdentityPools/pt-pneuma-github-sandbox/providers/pt-pneuma-github-sandbox
          service_account: pt-pneuma-github@pt-corpus-tf16-sand.iam.gserviceaccount.com

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.10.4

      - name: Tofu Init
        run: tofu init
        working-directory: regional/opa-gatekeeper

      - name: Tofu Workspace Select
        run: tofu workspace select us-east4-b-sandbox || tofu workspace new us-east4-b-sandbox
        working-directory: regional/opa-gatekeeper

      - name: Tofu Apply
        run: tofu apply -auto-approve -var-file=../environments/us-east4-b-sandbox.tfvars
        working-directory: regional/opa-gatekeeper

  opa-gatekeeper-us-east4-c-sandbox:
    name: OPA Gatekeeper us-east4-c-sandbox
    runs-on: ubuntu-latest
    needs: cert-manager-us-east4-c-sandbox
    environment: sandbox

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/228872504660/locations/global/workloadIdentityPools/pt-pneuma-github-sandbox/providers/pt-pneuma-github-sandbox
          service_account: pt-pneuma-github@pt-corpus-tf16-sand.iam.gserviceaccount.com

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.10.4

      - name: Tofu Init
        run: tofu init
        working-directory: regional/opa-gatekeeper

      - name: Tofu Workspace Select
        run: tofu workspace select us-east4-c-sandbox || tofu workspace new us-east4-c-sandbox
        working-directory: regional/opa-gatekeeper

      - name: Tofu Apply
        run: tofu apply -auto-approve -var-file=../environments/us-east4-c-sandbox.tfvars
        working-directory: regional/opa-gatekeeper

  datadog-us-east1-a-sandbox:
    name: Datadog us-east1-a-sandbox
    runs-on: ubuntu-latest
    needs: onboarding-us-east1-a-sandbox
    environment: sandbox

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/228872504660/locations/global/workloadIdentityPools/pt-pneuma-github-sandbox/providers/pt-pneuma-github-sandbox
          service_account: pt-pneuma-github@pt-corpus-tf16-sand.iam.gserviceaccount.com

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.10.4

      - name: Tofu Init
        run: tofu init
        working-directory: regional/datadog

      - name: Tofu Workspace Select
        run: tofu workspace select us-east1-a-sandbox || tofu workspace new us-east1-a-sandbox
        working-directory: regional/datadog

      - name: Tofu Apply
        run: tofu apply -auto-approve -var-file=../environments/us-east1-a-sandbox.tfvars
        working-directory: regional/datadog

  datadog-us-east1-b-sandbox:
    name: Datadog us-east1-b-sandbox
    runs-on: ubuntu-latest
    needs: onboarding-us-east1-b-sandbox
    environment: sandbox

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/228872504660/locations/global/workloadIdentityPools/pt-pneuma-github-sandbox/providers/pt-pneuma-github-sandbox
          service_account: pt-pneuma-github@pt-corpus-tf16-sand.iam.gserviceaccount.com

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.10.4

      - name: Tofu Init
        run: tofu init
        working-directory: regional/datadog

      - name: Tofu Workspace Select
        run: tofu workspace select us-east1-b-sandbox || tofu workspace new us-east1-b-sandbox
        working-directory: regional/datadog

      - name: Tofu Apply
        run: tofu apply -auto-approve -var-file=../environments/us-east1-b-sandbox.tfvars
        working-directory: regional/datadog

  datadog-us-east1-c-sandbox:
    name: Datadog us-east1-c-sandbox
    runs-on: ubuntu-latest
    needs: onboarding-us-east1-c-sandbox
    environment: sandbox

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/228872504660/locations/global/workloadIdentityPools/pt-pneuma-github-sandbox/providers/pt-pneuma-github-sandbox
          service_account: pt-pneuma-github@pt-corpus-tf16-sand.iam.gserviceaccount.com

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.10.4

      - name: Tofu Init
        run: tofu init
        working-directory: regional/datadog

      - name: Tofu Workspace Select
        run: tofu workspace select us-east1-c-sandbox || tofu workspace new us-east1-c-sandbox
        working-directory: regional/datadog

      - name: Tofu Apply
        run: tofu apply -auto-approve -var-file=../environments/us-east1-c-sandbox.tfvars
        working-directory: regional/datadog

  datadog-us-east4-a-sandbox:
    name: Datadog us-east4-a-sandbox
    runs-on: ubuntu-latest
    needs: onboarding-us-east4-a-sandbox
    environment: sandbox

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/228872504660/locations/global/workloadIdentityPools/pt-pneuma-github-sandbox/providers/pt-pneuma-github-sandbox
          service_account: pt-pneuma-github@pt-corpus-tf16-sand.iam.gserviceaccount.com

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.10.4

      - name: Tofu Init
        run: tofu init
        working-directory: regional/datadog

      - name: Tofu Workspace Select
        run: tofu workspace select us-east4-a-sandbox || tofu workspace new us-east4-a-sandbox
        working-directory: regional/datadog

      - name: Tofu Apply
        run: tofu apply -auto-approve -var-file=../environments/us-east4-a-sandbox.tfvars
        working-directory: regional/datadog

  datadog-us-east4-b-sandbox:
    name: Datadog us-east4-b-sandbox
    runs-on: ubuntu-latest
    needs: onboarding-us-east4-b-sandbox
    environment: sandbox

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/228872504660/locations/global/workloadIdentityPools/pt-pneuma-github-sandbox/providers/pt-pneuma-github-sandbox
          service_account: pt-pneuma-github@pt-corpus-tf16-sand.iam.gserviceaccount.com

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.10.4

      - name: Tofu Init
        run: tofu init
        working-directory: regional/datadog

      - name: Tofu Workspace Select
        run: tofu workspace select us-east4-b-sandbox || tofu workspace new us-east4-b-sandbox
        working-directory: regional/datadog

      - name: Tofu Apply
        run: tofu apply -auto-approve -var-file=../environments/us-east4-b-sandbox.tfvars
        working-directory: regional/datadog

  datadog-us-east4-c-sandbox:
    name: Datadog us-east4-c-sandbox
    runs-on: ubuntu-latest
    needs: onboarding-us-east4-c-sandbox
    environment: sandbox

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/228872504660/locations/global/workloadIdentityPools/pt-pneuma-github-sandbox/providers/pt-pneuma-github-sandbox
          service_account: pt-pneuma-github@pt-corpus-tf16-sand.iam.gserviceaccount.com

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.10.4

      - name: Tofu Init
        run: tofu init
        working-directory: regional/datadog

      - name: Tofu Workspace Select
        run: tofu workspace select us-east4-c-sandbox || tofu workspace new us-east4-c-sandbox
        working-directory: regional/datadog

      - name: Tofu Apply
        run: tofu apply -auto-approve -var-file=../environments/us-east4-c-sandbox.tfvars
        working-directory: regional/datadog

  istio-us-east1-a-sandbox:
    name: Istio us-east1-a-sandbox
    runs-on: ubuntu-latest
    needs: cert-manager-us-east1-a-sandbox
    environment: sandbox

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/228872504660/locations/global/workloadIdentityPools/pt-pneuma-github-sandbox/providers/pt-pneuma-github-sandbox
          service_account: pt-pneuma-github@pt-corpus-tf16-sand.iam.gserviceaccount.com

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.10.4

      - name: Tofu Init
        run: tofu init
        working-directory: regional/istio

      - name: Tofu Workspace Select
        run: tofu workspace select us-east1-a-sandbox || tofu workspace new us-east1-a-sandbox
        working-directory: regional/istio

      - name: Tofu Apply
        run: tofu apply -auto-approve -var-file=../environments/us-east1-a-sandbox.tfvars
        working-directory: regional/istio

  istio-us-east1-b-sandbox:
    name: Istio us-east1-b-sandbox
    runs-on: ubuntu-latest
    needs: cert-manager-us-east1-b-sandbox
    environment: sandbox

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/228872504660/locations/global/workloadIdentityPools/pt-pneuma-github-sandbox/providers/pt-pneuma-github-sandbox
          service_account: pt-pneuma-github@pt-corpus-tf16-sand.iam.gserviceaccount.com

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.10.4

      - name: Tofu Init
        run: tofu init
        working-directory: regional/istio

      - name: Tofu Workspace Select
        run: tofu workspace select us-east1-b-sandbox || tofu workspace new us-east1-b-sandbox
        working-directory: regional/istio

      - name: Tofu Apply
        run: tofu apply -auto-approve -var-file=../environments/us-east1-b-sandbox.tfvars
        working-directory: regional/istio

  istio-us-east1-c-sandbox:
    name: Istio us-east1-c-sandbox
    runs-on: ubuntu-latest
    needs: cert-manager-us-east1-c-sandbox
    environment: sandbox

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/228872504660/locations/global/workloadIdentityPools/pt-pneuma-github-sandbox/providers/pt-pneuma-github-sandbox
          service_account: pt-pneuma-github@pt-corpus-tf16-sand.iam.gserviceaccount.com

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.10.4

      - name: Tofu Init
        run: tofu init
        working-directory: regional/istio

      - name: Tofu Workspace Select
        run: tofu workspace select us-east1-c-sandbox || tofu workspace new us-east1-c-sandbox
        working-directory: regional/istio

      - name: Tofu Apply
        run: tofu apply -auto-approve -var-file=../environments/us-east1-c-sandbox.tfvars
        working-directory: regional/istio

  istio-us-east4-a-sandbox:
    name: Istio us-east4-a-sandbox
    runs-on: ubuntu-latest
    needs: cert-manager-us-east4-a-sandbox
    environment: sandbox

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/228872504660/locations/global/workloadIdentityPools/pt-pneuma-github-sandbox/providers/pt-pneuma-github-sandbox
          service_account: pt-pneuma-github@pt-corpus-tf16-sand.iam.gserviceaccount.com

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.10.4

      - name: Tofu Init
        run: tofu init
        working-directory: regional/istio

      - name: Tofu Workspace Select
        run: tofu workspace select us-east4-a-sandbox || tofu workspace new us-east4-a-sandbox
        working-directory: regional/istio

      - name: Tofu Apply
        run: tofu apply -auto-approve -var-file=../environments/us-east4-a-sandbox.tfvars
        working-directory: regional/istio

  istio-us-east4-b-sandbox:
    name: Istio us-east4-b-sandbox
    runs-on: ubuntu-latest
    needs: cert-manager-us-east4-b-sandbox
    environment: sandbox

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/228872504660/locations/global/workloadIdentityPools/pt-pneuma-github-sandbox/providers/pt-pneuma-github-sandbox
          service_account: pt-pneuma-github@pt-corpus-tf16-sand.iam.gserviceaccount.com

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.10.4

      - name: Tofu Init
        run: tofu init
        working-directory: regional/istio

      - name: Tofu Workspace Select
        run: tofu workspace select us-east4-b-sandbox || tofu workspace new us-east4-b-sandbox
        working-directory: regional/istio

      - name: Tofu Apply
        run: tofu apply -auto-approve -var-file=../environments/us-east4-b-sandbox.tfvars
        working-directory: regional/istio

  istio-us-east4-c-sandbox:
    name: Istio us-east4-c-sandbox
    runs-on: ubuntu-latest
    needs: cert-manager-us-east4-c-sandbox
    environment: sandbox

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/228872504660/locations/global/workloadIdentityPools/pt-pneuma-github-sandbox/providers/pt-pneuma-github-sandbox
          service_account: pt-pneuma-github@pt-corpus-tf16-sand.iam.gserviceaccount.com

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.10.4

      - name: Tofu Init
        run: tofu init
        working-directory: regional/istio

      - name: Tofu Workspace Select
        run: tofu workspace select us-east4-c-sandbox || tofu workspace new us-east4-c-sandbox
        working-directory: regional/istio

      - name: Tofu Apply
        run: tofu apply -auto-approve -var-file=../environments/us-east4-c-sandbox.tfvars
        working-directory: regional/istio
